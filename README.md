<svg style="max-width: 320px; margin: 0 auto; display: block" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" clip-rule="evenodd" viewBox="0 0 717 200"><path fill="none" d="M0 0h716.031v200H0z"/><path fill="#e96a53" d="M27 25h330v150H27z"/><path fill="#6e588b" d="M362.015 25h98v150h-98z"/><path fill="#e96a53" d="M465 25h222.2v150H465z"/><path fill="#fff" fill-rule="nonzero" d="M107.452 146.981c-9.226 0-17.299-2.094-24.219-6.282-6.92-4.188-12.292-9.864-16.116-17.026-3.824-7.163-5.736-15.054-5.736-23.673 0-8.741 1.821-16.662 5.463-23.764 3.642-7.102 8.862-12.747 15.661-16.935 6.798-4.188 14.81-6.282 24.037-6.282 9.347 0 17.39 2.094 24.128 6.282 6.737 4.188 11.927 9.833 15.569 16.935 3.642 7.102 5.463 15.023 5.463 23.764v5.463H75.403c.728 5.342 2.458 10.228 5.19 14.659 2.731 4.431 6.403 7.952 11.017 10.562 4.613 2.61 9.954 3.915 16.024 3.915 6.434 0 11.837-1.427 16.207-4.28 4.37-2.852 7.77-6.525 10.198-11.017h14.932c-3.157 8.134-8.164 14.781-15.023 19.94-6.859 5.16-15.691 7.739-26.496 7.739ZM75.585 92.716h61.914c-1.214-7.769-4.492-14.264-9.834-19.485-5.341-5.22-12.383-7.83-21.123-7.83-8.741 0-15.752 2.61-21.033 7.83-5.281 5.221-8.589 11.716-9.924 19.485Zm92.87 52.809v-91.05h13.658v14.204c3.277-4.37 7.284-8.073 12.018-11.108 4.735-3.035 10.805-4.552 18.21-4.552 6.313 0 12.231 1.487 17.755 4.461 5.523 2.974 10.015 7.405 13.475 13.293 3.46 5.888 5.19 13.142 5.19 21.761v52.991h-13.658V92.898c0-8.255-2.367-14.902-7.101-19.94-4.735-5.038-10.866-7.557-18.392-7.557-5.099 0-9.712 1.154-13.84 3.46-4.127 2.307-7.436 5.554-9.924 9.742-2.489 4.189-3.733 9.014-3.733 14.477v52.445h-13.658Zm142.219 1.456c-9.105 0-16.995-2.094-23.672-6.282-6.677-4.188-11.867-9.864-15.57-17.026-3.703-7.163-5.554-15.054-5.554-23.673 0-8.741 1.851-16.662 5.554-23.764 3.703-7.102 8.893-12.747 15.57-16.935 6.677-4.188 14.567-6.282 23.672-6.282 10.805 0 20.001 2.792 27.588 8.376 7.588 5.584 12.717 12.808 15.388 21.67H338.9c-2.064-5.22-5.372-9.469-9.925-12.747-4.552-3.278-10.045-4.917-16.48-4.917-6.677 0-12.504 1.578-17.481 4.735-4.977 3.156-8.802 7.344-11.472 12.565-2.671 5.22-4.006 10.986-4.006 17.299 0 6.191 1.335 11.927 4.006 17.208 2.67 5.281 6.495 9.5 11.472 12.656 4.977 3.157 10.804 4.735 17.481 4.735 6.435 0 11.928-1.639 16.48-4.917 4.553-3.278 7.861-7.527 9.925-12.747h14.75c-2.671 8.862-7.8 16.086-15.388 21.67-7.587 5.584-16.783 8.376-27.588 8.376Zm98.334 0c-8.862 0-16.602-2.094-23.218-6.282-6.616-4.188-11.745-9.864-15.387-17.026-3.642-7.163-5.463-15.054-5.463-23.673 0-8.741 1.821-16.662 5.463-23.764 3.642-7.102 8.771-12.747 15.387-16.935 6.616-4.188 14.356-6.282 23.218-6.282 7.527 0 13.991 1.456 19.393 4.37 5.403 2.913 9.803 6.859 13.202 11.836v-14.75h13.658v91.05h-13.658v-14.568c-3.399 4.856-7.799 8.741-13.202 11.654-5.402 2.914-11.866 4.37-19.393 4.37Zm1.821-12.382c6.798 0 12.534-1.578 17.208-4.735 4.674-3.156 8.225-7.375 10.653-12.656 2.428-5.281 3.642-11.017 3.642-17.208 0-6.313-1.214-12.079-3.642-17.299-2.428-5.221-5.979-9.409-10.653-12.565-4.674-3.157-10.41-4.735-17.208-4.735-6.677 0-12.444 1.578-17.3 4.735-4.856 3.156-8.558 7.344-11.108 12.565-2.549 5.22-3.824 10.986-3.824 17.299 0 6.191 1.275 11.927 3.824 17.208 2.55 5.281 6.252 9.5 11.108 12.656 4.856 3.157 10.623 4.735 17.3 4.735Zm101.247 12.382c-8.377 0-15.448-1.396-21.215-4.188-5.766-2.792-10.167-6.464-13.202-11.017-3.035-4.552-4.735-9.499-5.099-14.841h14.204c.364 3.035 1.426 5.979 3.187 8.832 1.76 2.853 4.461 5.159 8.103 6.92 3.642 1.76 8.377 2.64 14.204 2.64 1.821 0 4.067-.182 6.737-.546 2.671-.364 5.251-1.032 7.74-2.003 2.488-.971 4.582-2.428 6.282-4.371 1.7-1.942 2.549-4.431 2.549-7.466 0-3.763-1.456-6.677-4.37-8.74-2.914-2.064-6.677-3.673-11.29-4.826-4.613-1.153-9.5-2.276-14.659-3.369-5.16-1.092-10.046-2.519-14.659-4.279-4.613-1.76-8.377-4.249-11.29-7.466-2.914-3.217-4.37-7.618-4.37-13.202 0-8.256 3.004-14.659 9.013-19.212 6.01-4.552 14.902-6.828 26.678-6.828 8.012 0 14.537 1.244 19.575 3.733 5.039 2.488 8.863 5.675 11.473 9.56 2.61 3.885 4.158 8.073 4.643 12.565h-13.839c-.486-3.885-2.398-7.224-5.736-10.016-3.339-2.792-8.832-4.188-16.48-4.188-14.447 0-21.67 4.37-21.67 13.111 0 3.642 1.457 6.434 4.37 8.376 2.914 1.943 6.677 3.491 11.29 4.644 4.614 1.153 9.5 2.246 14.659 3.278 5.16 1.032 10.046 2.458 14.659 4.279 4.613 1.821 8.377 4.401 11.29 7.739 2.914 3.339 4.371 7.861 4.371 13.567 0 8.862-3.369 15.63-10.107 20.304-6.737 4.674-15.751 7.01-27.041 7.01Zm95.055 0c-9.226 0-17.299-2.094-24.219-6.282-6.92-4.188-12.292-9.864-16.116-17.026-3.824-7.163-5.736-15.054-5.736-23.673 0-8.741 1.821-16.662 5.463-23.764 3.642-7.102 8.862-12.747 15.661-16.935 6.798-4.188 14.81-6.282 24.037-6.282 9.347 0 17.39 2.094 24.128 6.282 6.737 4.188 11.927 9.833 15.569 16.935 3.642 7.102 5.463 15.023 5.463 23.764v5.463h-76.299c.728 5.342 2.458 10.228 5.19 14.659 2.731 4.431 6.403 7.952 11.017 10.562 4.613 2.61 9.954 3.915 16.024 3.915 6.434 0 11.837-1.427 16.207-4.28 4.37-2.852 7.77-6.525 10.198-11.017h14.932c-3.157 8.134-8.164 14.781-15.023 19.94-6.859 5.16-15.691 7.739-26.496 7.739Zm-31.867-54.265h61.914c-1.214-7.769-4.492-14.264-9.834-19.485-5.341-5.22-12.383-7.83-21.123-7.83-8.741 0-15.752 2.61-21.033 7.83-5.281 5.221-8.589 11.716-9.924 19.485Z"/></svg>

Provides a mechanism to lay out data into GPU buffers ensuring WGSL's memory layout requirements are met.

## Features

- supports all WGSL [host-shareable types] + wrapper types (`&T`, `&mut T`, `Box<T>`, ...)
- supports data types from a multitude of crates as [features]
- covers a wide area of use cases (see [examples](#examples))

## Motivation

Having to manually lay out data into GPU buffers can become very tedious and error prone. How do you make sure the data in the buffer is laid out correctly? Enforce it so that future changes don't break this delicate balance?

`encase` gives you the ability to make sure at compile time that your types will be laid out correctly.

## Design

The core trait is [`WgslType`] which mainly contains metadata about the given type.

The [`WriteInto`], [`ReadFrom`] and [`CreateFrom`] traits represent the ability of a type to be written into the buffer, read from the buffer and created from the buffer respectively.

Most data types can implement the above traits via their respective macros:

  - [`impl_vector!`] for vectors
  - [`impl_matrix!`] for matrices
  - [`impl_rts_array!`] for runtime-sized arrays
  - [`impl_wrapper!`] for wrappers
  - [`WgslType`][derive@WgslType] for structs

The [`UniformBuffer`], [`StorageBuffer`], [`DynamicUniformBuffer`] and [`DynamicStorageBuffer`] structs are wrappers around an underlying raw buffer (a type implementing [`BufferRef`] and/or [`BufferMut`] depending on required capability). They facilitate the read/write/create operations.

## Examples

Write affine transform to uniform buffer

```rust
use encase::{WgslType, UniformBuffer};

#[derive(WgslType)]
struct AffineTransform2D {
    matrix: glam::Mat2,
    translate: glam::Vec2
}

let transform = AffineTransform2D {
    matrix: glam::Mat2::IDENTITY,
    translate: glam::Vec2::ZERO,
};

let mut buffer = UniformBuffer::new(Vec::new());
buffer.write(&transform).unwrap();
let byte_buffer = buffer.into_inner();

// write byte_buffer to GPU

assert_eq!(&byte_buffer, &[0, 0, 128, 63, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 128, 63, 0, 0, 0, 0, 0, 0, 0, 0]);
```

Create vector instance by reading from dynamic uniform buffer at specific offset

```rust
use encase::DynamicUniformBuffer;

// read byte_buffer from GPU
let byte_buffer = [1u8; 256 + 8];

let mut buffer = DynamicUniformBuffer::new(&byte_buffer);
buffer.set_offset(256);
let vector: mint::Vector2<i32> = buffer.create().unwrap();

assert_eq!(vector, mint::Vector2 { x: 16843009, y: 16843009 });
```

Write and read back data from storage buffer

```rust
use encase::{WgslType, ArrayLength, StorageBuffer};

#[derive(WgslType)]
struct Positions {
    length: ArrayLength,
    #[size(runtime)]
    positions: Vec<mint::Point2<f32>>
}

let mut positions = Positions {
    length: ArrayLength,
    positions: Vec::from([
        mint::Point2 { x: 4.5, y: 3.4 },
        mint::Point2 { x: 1.5, y: 7.4 },
        mint::Point2 { x: 4.3, y: 1.9 },
    ])
};

let mut byte_buffer = Vec::new();

let mut buffer = StorageBuffer::new(&mut byte_buffer);
buffer.write(&positions).unwrap();

// write byte_buffer to GPU

// change length on GPU side
byte_buffer[0] = 2;

// read byte_buffer from GPU

let mut buffer = StorageBuffer::new(&mut byte_buffer);
buffer.read(&mut positions).unwrap();

assert_eq!(positions.positions.len(), 2);

```

Write different data types to dynamic storage buffer

```rust
use encase::{WgslType, DynamicStorageBuffer};

let mut byte_buffer = Vec::new();

let mut buffer = DynamicStorageBuffer::new_with_alignment(&mut byte_buffer, 64);
let offsets = [
    buffer.write(&[5.; 10]).unwrap(),
    buffer.write(&vec![3u32; 20]).unwrap(),
    buffer.write(&glam::Vec3::ONE).unwrap(),
];

// write byte_buffer to GPU

assert_eq!(offsets, [0, 64, 192]);

```

[host-shareable types]: https://gpuweb.github.io/gpuweb/wgsl/#host-shareable-types
[features]: https://docs.rs/crate/encase/latest/features
[`WgslType`]: https://docs.rs/crate/encase/latest/encase/trait.WgslType.html

[`WriteInto`]: https://docs.rs/crate/encase/latest/encase/internal/trait.WriteInto.html
[`ReadFrom`]: https://docs.rs/crate/encase/latest/encase/internal/trait.ReadFrom.html
[`CreateFrom`]: https://docs.rs/crate/encase/latest/encase/internal/trait.CreateFrom.html

[`impl_vector!`]: https://docs.rs/crate/encase/latest/encase/macro.impl_vector.html
[`impl_matrix!`]: https://docs.rs/crate/encase/latest/encase/macro.impl_matrix.html
[`impl_rts_array!`]: https://docs.rs/crate/encase/latest/encase/macro.impl_rts_array.html
[`impl_wrapper!`]: https://docs.rs/crate/encase/latest/encase/macro.impl_wrapper.html
[derive@WgslType]: https://docs.rs/crate/encase/latest/encase/derive.WgslType.html

[`UniformBuffer`]: https://docs.rs/crate/encase/latest/encase/struct.UniformBuffer.html
[`StorageBuffer`]: https://docs.rs/crate/encase/latest/encase/struct.StorageBuffer.html
[`DynamicUniformBuffer`]: https://docs.rs/crate/encase/latest/encase/struct.DynamicUniformBuffer.html
[`DynamicStorageBuffer`]: https://docs.rs/crate/encase/latest/encase/struct.DynamicStorageBuffer.html

[`BufferRef`]: https://docs.rs/crate/encase/latest/encase/internal/trait.BufferRef.html
[`BufferMut`]: https://docs.rs/crate/encase/latest/encase/internal/trait.BufferMut.html